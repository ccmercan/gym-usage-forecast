{% extends "base.html" %}
{% block content %}
<div class="card">
    <h1> Raider Power Zone Forecasting</h1>
    
    <form method="post" action="/" id="settings-form">
        <h2>‚öôÔ∏è Settings</h2>
        {% if saved %}
        <div class="success">‚úì Settings saved successfully!</div>
        {% endif %}
        
        <div class="form-row">
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" name="email" value="" placeholder="your.email@ttu.edu" autocomplete="email">
            </div>
            
            <div class="form-group">
                <label>Digest Send Time (HH:MM)</label>
                <input type="time" name="digest_time" value="{{ prefs.digest_send_time_local if prefs else '07:00' }}">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>Preferred Start Time (HH:MM)</label>
                <input type="time" name="start_time" value="{{ prefs.preferred_start_time_local if prefs else '06:00' }}" required>
            </div>
            
            <div class="form-group">
                <label>Preferred End Time (HH:MM)</label>
                <input type="time" name="end_time" value="{{ prefs.preferred_end_time_local if prefs else '22:00' }}" required>
            </div>
        </div>
        
        <div class="form-group">
            <label>Workout Duration (minutes)</label>
            <input type="number" name="workout_duration" min="15" max="240" step="15" value="{{ prefs.workout_duration_minutes if prefs else 60 }}" required>
            <small style="color: #666;">How long do you typically work out? (15-240 minutes)</small>
        </div>
        
        <div class="form-group">
            <label>Areas of Interest</label>
            <div class="checkbox-group">
                {% for facility in available_facilities %}
                <label class="checkbox-label">
                    <input type="checkbox" name="areas" value="{{ facility }}" 
                           {% if prefs and prefs.areas_of_interest and facility in prefs.areas_of_interest %}checked{% endif %}>
                    <span>{{ facility }}</span>
                </label>
                {% endfor %}
            </div>
            <small style="color: #666;">Select facilities to track. Leave all unchecked to track all facilities.</small>
        </div>
        
        <button type="submit">üíæ Save Settings</button>
    </form>
</div>

<div class="card">
    <h1> Dashboard</h1>
    
    <h2> Best Times Today</h2>
    {% if recommendations %}
        <p style="color: #666; margin-bottom: 1rem;">
            Based on last 2 weeks of data for {{ prefs.areas_of_interest|length if prefs.areas_of_interest else 'all' }} selected facility{{ 'ies' if prefs.areas_of_interest|length != 1 else '' }}.
            Recommended {{ prefs.workout_duration_minutes if prefs else 60 }}-minute workout windows:
        </p>
        {% for time_range, pct in recommendations %}
        <div class="recommendation">
            <strong>{{ time_range }}</strong> - {{ "%.1f"|format(pct) }}% average usage
        </div>
        {% endfor %}
    {% else %}
        <p>No recommendations available. Make sure you have data and preferences configured.</p>
    {% endif %}
    
    <h2> Usage Heatmap (Average Usage by Day & Hour)</h2>
    {% if heatmap %}
    <p style="color: #666; margin-bottom: 1rem;">Day of week √ó Hour of day (6am-12am) - Green: Low, Orange: Medium, Red: High</p>
    <div style="overflow-x: auto;">
        <table style="font-size: 0.85rem; border-collapse: collapse; width: 100%;">
            <thead>
                <tr>
                    <th style="padding: 0.5rem; background: #f8f9fa;">Day/Hour</th>
                    {% for h in range(6, 24) %}
                    <th style="padding: 0.5rem; background: #f8f9fa; font-size: 0.75rem;">{{ h }}:00</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% set days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] %}
                {% for day in range(7) %}
                <tr>
                    <th style="padding: 0.5rem; background: #f8f9fa; text-align: left;">{{ days[day] }}</th>
                    {% for h in range(6, 24) %}
                    {% set val = heatmap.get((day, h)) %}
                    <td style="padding: 0.5rem; text-align: center; border: 1px solid #ddd; background: {% if val %}{% if val < 30 %}rgba(76, 175, 80, 0.4){% elif val < 70 %}rgba(255, 152, 0, 0.4){% else %}rgba(244, 67, 54, 0.4){% endif %}{% else %}#f5f5f5{% endif %}; min-width: 40px;">
                        {% if val %}{{ "%.0f"|format(val) }}%{% else %}-{% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>No heatmap data available. Make sure you have data and preferences configured.</p>
    {% endif %}
</div>
{% endblock %}
