{% extends "base.html" %}
{% block content %}
<div class="card">
    <h1>ðŸ“Š Dashboard</h1>
    {% if error %}
    <div class="error">{{ error }}</div>
    <p><a href="/settings">Configure your preferences</a> to see recommendations.</p>
    {% else %}
    
    <h2>ðŸŽ¯ Best Times Today</h2>
    {% if recommendations %}
        {% for hour, pct in recommendations %}
        <div class="recommendation">
            <strong>{{ hour }}:00</strong> - {{ "%.1f"|format(pct) }}% average usage
        </div>
        {% endfor %}
    {% else %}
        <p>No recommendations available. Make sure you have data and preferences configured.</p>
    {% endif %}
    
    <h2>ðŸ“ˆ Latest Facility Data</h2>
    {% if latest %}
    <table>
        <thead>
            <tr>
                <th>Facility</th>
                <th>Usage</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody>
            {% for snap in latest %}
            <tr>
                <td>{{ snap.location_name }}</td>
                <td>
                    <strong style="color: {% if snap.usage_percentage < 30 %}#4caf50{% elif snap.usage_percentage < 70 %}#ff9800{% else %}#f44336{% endif %};">
                        {{ snap.usage_percentage }}%
                    </strong>
                </td>
                <td>{{ snap.timestamp_utc.strftime('%Y-%m-%d %H:%M') if snap.timestamp_utc else 'N/A' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No data available yet. Run <code>make ingest</code> to collect facility data.</p>
    {% endif %}
    
    <h2>ðŸ”¥ Usage Heatmap (Average Usage by Day & Hour)</h2>
    {% if heatmap %}
    <p style="color: #666; margin-bottom: 1rem;">Day of week Ã— Hour of day (Green: Low, Orange: Medium, Red: High)</p>
    <div style="overflow-x: auto;">
        <table style="font-size: 0.85rem; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="padding: 0.5rem; background: #f8f9fa;">Day/Hour</th>
                    {% for h in range(24) %}
                    <th style="padding: 0.5rem; background: #f8f9fa; font-size: 0.75rem;">{{ h }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% set days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] %}
                {% for day in range(7) %}
                <tr>
                    <th style="padding: 0.5rem; background: #f8f9fa; text-align: left;">{{ days[day] }}</th>
                    {% for h in range(24) %}
                    {% set val = heatmap.get((day, h)) %}
                    <td style="padding: 0.5rem; text-align: center; border: 1px solid #ddd; background: {% if val %}{% if val < 30 %}rgba(76, 175, 80, 0.4){% elif val < 70 %}rgba(255, 152, 0, 0.4){% else %}rgba(244, 67, 54, 0.4){% endif %}{% else %}#f5f5f5{% endif %}; min-width: 40px;">
                        {% if val %}{{ "%.0f"|format(val) }}%{% else %}-{% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>No heatmap data available. Make sure you have data and preferences configured.</p>
    {% endif %}
    
    {% endif %}
</div>
{% endblock %}
